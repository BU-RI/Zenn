---
title: "é«˜æ ¡ç”Ÿã§ã‚‚ã§ãã‚‹! Difyã‚’Next.jsã«å®Ÿè£…"
emoji: "ğŸš€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ dify, nextjs, åˆå¿ƒè€…, ai, ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ ]
published: true
---

â€
â€

![](/images/difynextjs/samune.drawio.png)

â€
â€

# ğŸ¯ ã¯ã˜ã‚ã«
ã“ã‚“ã«ã¡ã¯ï¼ä»Šå›ã¯Difyã‚’ä½¿ç”¨ã—ãŸwebã‚¢ãƒ—ãƒªã®åˆ¶ä½œéç¨‹ã‚’ã€ãƒãƒ³ã‚ºã‚ªãƒ³å½¢å¼ã§ã”ç´¹ä»‹ã—ã¾ã™ï¼
ã“ã®è¨˜äº‹ã‚’èª­ã‚€ã“ã¨ã§ã€APIã‚­ãƒ¼ã®å–å¾—ã‹ã‚‰å®Ÿè£…ã¾ã§ã€ä¸€é€£ã®æµã‚Œã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](/images/difynextjs/finalresult.png)

**å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã“ã‚“ãªæ„Ÿã˜ï¼** ã‚·ãƒ³ãƒ—ãƒ«ã§ä½¿ã„ã‚„ã™ã„ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆãŒä½œã‚Œã¾ã™âœ¨

## ğŸ“Š ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æµã‚Œ

![](/images/difynextjs/finaldifynext.drawio.png)

ã“ã®ã‚¢ãƒ—ãƒªã¯ã“ã®ã‚ˆã†ãªæµã‚Œã§å‹•ä½œã—ã¾ã™ã€‚
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›
2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰Next.jsã®API Routeã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
3. API RouteãŒDify APIã‚’å‘¼ã³å‡ºã—
4. Difyã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«è¿”ã™
5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¤º

## ğŸ“š å‰æçŸ¥è­˜

https://zenn.dev/bu_ri/articles/dify_chat_highs

Difyã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã‹ã‚‰ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆä½œæˆã¾ã§ã®æ‰‹é †ã¯ã“ã¡ã‚‰ã®è¨˜äº‹ã§è§£èª¬ã—ã¦ã„ã¾ã™ğŸ‘†
ã¾ãšã¯ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã€Difyã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼

# ğŸ› ï¸ è£½ä½œé–‹å§‹ï¼ï¼

ãã‚Œã§ã¯ã€å®Ÿéš›ã«AIã‚’ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ï¼

## ğŸ¤– AIä½œæˆã‹APIã‚­ãƒ¼å–å¾—ã¾ã§

### 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
![](/images/difynextjs/newproject.png)

### 2. AIã‚¿ã‚¤ãƒ—ã®é¸æŠ
ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’é¸æŠã—ã€ã‚¢ãƒ—ãƒªåã‚’æ±ºã‚ã¾ã—ã‚‡ã†ï¼
![](/images/difynextjs/selectaitype.png)

### 3. AIãƒ¢ãƒ‡ãƒ«ã®è¨­å®š
ä½¿ç”¨ã™ã‚‹AIãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã€åŸºæœ¬è¨­å®šã‚’å®Œäº†ã•ã›ã¾ã™
![](/images/difynextjs/completeAI.png)

### 4. APIè¨­å®š
APIã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã¿ã¾ã—ã‚‡ã†
![](/images/difynextjs/apipage.png)


### 5. APIã‚­ãƒ¼ã®å–å¾—
APIã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®æ‰‹é †ã§é€²ã‚ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
![](/images/difynextjs/apikey.png)

:::message alert
**é‡è¦ï¼**
å–å¾—ã—ãŸAPIã‚­ãƒ¼ã¯å¿…ãšå®‰å…¨ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚ä»–äººã¨å…±æœ‰ã—ãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚
:::

### 6. APIã®å‹•ä½œç¢ºèª
å®Ÿéš›ã«APIãŒå‹•ä½œã™ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ä»¥ä¸‹ã®curlã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
curl -X POST 'https://api.dify.ai/v1/chat-messages' \
--header 'Authorization: Bearer YOUR-SECRET-KEY' \
--header 'Content-Type: application/json' \
--data-raw '{
    "inputs": {},
    "query": "What are the specs of the iPhone 13 Pro Max?",
    "response_mode": "streaming",   
    "conversation_id": "",
    "user": "abc-123",
    "files": [
      {
        "type": "image",
        "transfer_method": "remote_url",
        "url": "https://cloud.dify.ai/logo/logo-site.png"
      }
    ]
}''
```

å®Ÿè¡Œçµæœã¯ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
![](/images/difynextjs/curlresult.png)

`answer`ã®éƒ¨åˆ†ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã­ï¼

## ğŸ’» Next.jsã§é–‹ç™º

### 1. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
ã¾ãšã¯Next.jsã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚

```bash
npx create-next-app@latest dify_next_app
```

### 2. å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ç¢ºèª
`package.json`ã®å†…å®¹ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```json:package.json
{
  "name": "dify",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "next": "15.2.4",
    "react": "^19.0.0",
    "react-dom": "^19.0.0"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.21",
    "eslint": "^9",
    "eslint-config-next": "15.2.4",
    "postcss": "^8.5.3",
    "tailwindcss": "^3.4.1",
    "typescript": "^5"
  }
}
```

:::message
**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
ã‚³ãƒ”ãƒšãŒã§ããŸã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ï¼š
```bash
npmã€€install
```
:::

### 3. APIã®å®Ÿè£…
`api/chat/route.ts`ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

:::message alert
**æ³¨æ„ç‚¹**
`YOUR-SECRET-KEY`ã®éƒ¨åˆ†ã¯ã€å…ˆã»ã©å–å¾—ã—ãŸAPIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼
:::

```ts:chat/route.ts
import { NextResponse } from 'next/server';

export async function POST(request: Request) {
  try {
    const { message } = await request.json();

    if (!process.env.NEXT_PUBLIC_DIFY_API_KEY) {
      throw new Error('DIFY_API_KEY is not set in environment variables');
    }

    const response = await fetch('https://api.dify.ai/v1/chat-messages', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer YOUR-SECRET-KEY`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        inputs: {},
        query: message,
        response_mode: 'blocking',
        conversation_id: '',
        user: 'user-123',
        files: []
      }),
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => null);
      console.error('Dify API Error:', {
        status: response.status,
        statusText: response.statusText,
        errorData,
      });
      throw new Error(`Dify API request failed: ${response.status} ${response.statusText}`);
    }

    const data = await response.json();
    return NextResponse.json({ 
      answer: data.answer,
      conversation_id: data.conversation_id 
    });
  } catch (error) {
    console.error('Error details:', {
      message: error instanceof Error ? error.message : 'Unknown error',
      stack: error instanceof Error ? error.stack : undefined,
    });

    return NextResponse.json(
      { 
        error: 'Internal Server Error',
        details: error instanceof Error ? error.message : 'Unknown error occurred',
      },
      { status: 500 }
    );
  }
} 
```

### 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…
ã‚·ãƒ³ãƒ—ãƒ«ã§ä½¿ã„ã‚„ã™ã„ãƒãƒ£ãƒƒãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```tsx:page.tsx
'use client';

import { useState } from 'react';

export default function Home() {
  const [input, setInput] = useState('');
  const [answer, setAnswer] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!input.trim() || isLoading) return;

    setIsLoading(true);
    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: input }),
      });

      if (!res.ok) {
        throw new Error('API request failed');
      }

      const data = await res.json();
      setAnswer(data.answer);
    } catch (error) {
      console.error('Error:', error);
      setAnswer('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div>
      <h1>Difyãƒãƒ£ãƒƒãƒˆ</h1>
      
      <form onSubmit={handleSubmit}>
        <input
          type="text"
          value={input}
          onChange={(e) => setInput(e.target.value)}
          placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
          disabled={isLoading}
        />
        <button
          type="submit"
          disabled={isLoading}
        >
          {isLoading ? 'é€ä¿¡ä¸­...' : 'é€ä¿¡'}
        </button>
      </form>

      <div>
        <p>{answer}</p>
      </div>
    </div>
  );
} 
```

# ğŸ‰ å‹•ä½œç¢ºèª

é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã€å®Ÿéš›ã«å‹•ä½œç¢ºèªã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼

```bash
npm run dev
```

èµ·å‹•ç›´å¾Œã®ç”»é¢ï¼š
![](/images/difynextjs/final.png)

å®Ÿéš›ã«è³ªå•ã—ã¦ã¿ã‚‹ã¨...
![](/images/difynextjs/finalresult.png)

ã¡ã‚ƒã‚“ã¨AIãŒå¿œç­”ã—ã¦ãã‚Œã¾ã—ãŸï¼ğŸ˜Š

# ğŸŒŸ æœ€å¾Œã«
ã“ã‚Œã§ã€Difyã§ä½œæˆã—ãŸAIã‚’Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«çµ„ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã—ãŸï¼
ã“ã‚Œã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã†ã¾ãæ´»ç”¨ã™ã‚Œã°ã€ã“ã®ã‚ˆã†ãªãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚‚ã§ãã¾ã™

![](/images/difynextjs/example.png)

ã“ã®è¨˜äº‹ãŒã€ã¿ãªã•ã‚“ã®Webã‚¢ãƒ—ãƒªåˆ¶ä½œã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

ã“ã‚Œã‹ã‚‰ã‚‚ã€ã‚ˆã‚Šè‰¯ã„ã‚¢ãƒ—ãƒªåˆ¶ä½œã‚’ç›®æŒ‡ã—ã¦é ‘å¼µã£ã¦ã„ãã¾ã—ã‚‡ã†ï¼âœ¨